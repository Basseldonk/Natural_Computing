<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/simulation/Simulation.js | cpmjs</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Canvas.js~Canvas.html">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DiceSet.js~DiceSet.html">DiceSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Stats.js~Stats.html">Stats</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#grid">grid</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/CoarseGrid.js~CoarseGrid.html">CoarseGrid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/Grid.js~Grid.html">Grid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/Grid2D.js~Grid2D.html">Grid2D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/Grid3D.js~Grid3D.html">Grid3D</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/GridManipulator.js~GridManipulator.html">GridManipulator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grid/Margolus2D.js~Margolus2D.html">Margolus2D</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#hamiltonian">hamiltonian</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ActivityConstraint.js~ActivityConstraint.html">ActivityConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ActivityConstraintOld.js~ActivityConstraint.html">ActivityConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ActivityMultiBackground.js~ActivityMultiBackground.html">ActivityMultiBackground</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/Adhesion.js~Adhesion.html">Adhesion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/AdhesionMultiBackground.js~AdhesionMultiBackground.html">AdhesionMultiBackground</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/AttractionPointConstraint.js~AttractionPointConstraint.html">AttractionPointConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/BarrierConstraint.js~BarrierConstraint.html">BarrierConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ChemotaxisConstraint.js~ChemotaxisConstraint.html">ChemotaxisConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ChemotaxisConstraintOld.js~ChemotaxisConstraint.html">ChemotaxisConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/Constraint.js~Constraint.html">Constraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/HardConstraint.js~HardConstraint.html">HardConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/HardVolumeRangeConstraint.js~HardVolumeRangeConstraint.html">HardVolumeRangeConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/PerimeterConstraint.js~PerimeterConstraint.html">PerimeterConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/PersistenceConstraint.js~PersistenceConstraint.html">PersistenceConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/PreferredDirectionConstraint.js~PreferredDirectionConstraint.html">PreferredDirectionConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/ProtrusionConstraint.js~ProtrusionConstraint.html">ProtrusionConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/SoftConstraint.js~SoftConstraint.html">SoftConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/TestLogger.js~HardVolumeRangeConstraint.html">HardVolumeRangeConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/hamiltonian/VolumeConstraint.js~VolumeConstraint.html">VolumeConstraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AutoAdderConfig">AutoAdderConfig</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models">models</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/CA.js~CA.html">CA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/CPM.js~CPM.html">CPM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/GridBasedModel.js~GridBasedModel.html">GridBasedModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#simulation">simulation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/simulation/Simulation.js~Simulation.html">Simulation</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#stats">stats</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats/Centroids.js~Centroids.html">Centroids</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats/CentroidsWithTorusCorrection.js~CentroidsWithTorusCorrection.html">CentroidsWithTorusCorrection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats/PixelsByCell.js~PixelsByCell.html">PixelsByCell</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats/PostMCSStats.js~PostMCSStats.html">PostMCSStats</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats/Stat.js~Stat.html">Stat</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/simulation/Simulation.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import CPM from &quot;../models/CPM.js&quot;
import Canvas from &quot;../Canvas.js&quot;
import GridManipulator from &quot;../grid/GridManipulator.js&quot;
import CentroidsWithTorusCorrection from &quot;../stats/CentroidsWithTorusCorrection.js&quot;

class Simulation {
	constructor( config, custommethods ){
	
		custommethods = custommethods || {}
	
		// overwrite default method if methods are supplied in custommethods
		// these can be initializeGrid(), drawCanvas(), logStats(),
		// postMCSListener().
		for( let m of Object.keys( custommethods ) ){
			this[m] = custommethods[m]
		}
		
	
		// Configuration of the simulation environment
		this.conf = config.simsettings
		this.imgrate = this.conf[&quot;IMGFRAMERATE&quot;] || 1
		this.lograte = this.conf[&quot;LOGRATE&quot;] || 1
		
		// See if code is run in browser or via node, which will be used
		// below to determine what the output should be.
		if( typeof window !== &quot;undefined&quot; &amp;&amp; typeof window.document !== &quot;undefined&quot; ){
			this.mode = &quot;browser&quot;
		} else {
			this.mode = &quot;node&quot;
		}
		
		// Log stats or not
		this.logstats = this.conf[&quot;STATSOUT&quot;] || { browser: false, node: true }
		this.logstats = this.logstats[this.mode]
		
		// Saving images
		this.saveimg = this.conf[&quot;SAVEIMG&quot;] || false
		this.savepath = this.conf[&quot;SAVEPATH&quot;] || &quot;undefined&quot;
		
		if( this.saveimg &amp;&amp; this.savepath === &quot;undefined&quot; ){
			throw( &quot;You need to specify the SAVEPATH option in the configuration object of your simulation!&quot;)
		}
		
		// Save the time of the simulation.
		this.time = 0
		this.running = true
		
		// Make CPM object and add constraints
		this.C = new CPM( config.field_size, config.conf )
				
		// To add canvas / gridmanipulator automatically when required. This will set
		// their values in helpClasses to &apos;true&apos;, so they don&apos;t have to be added again.
		this.helpClasses = { gm: false, canvas: false }
		
		// Initialize the grid and run the burnin.
		this.initializeGrid()
		this.runBurnin()
		
	}

	// Add GridManipulator/Canvas objects when required.
	addGridManipulator(){
		this.gm = new GridManipulator( this.C )
		this.helpClasses[ &quot;gm&quot; ] = true
	}
	addCanvas(){
		let zoom = this.conf.zoom || 2
		this.Cim = new Canvas( this.C, {zoom:zoom} )
		this.helpClasses[ &quot;canvas&quot; ] = true
	}
	
	// Method to initialize the Grid should be implemented in each simulation.
	initializeGrid(){
	
		// add the initializer if not already there
		if( !this.helpClasses[&quot;gm&quot;] ){ this.addGridManipulator() }
	
		let nrcells = this.conf[&quot;NRCELLS&quot;], cellkind, i
		
		// Seed the right number of cells for each cellkind
		for( cellkind = 0; cellkind &lt; nrcells.length; cellkind ++ ){
			
			for( i = 0; i &lt; nrcells[cellkind]; i++ ){
				// first cell always at the midpoint. Any other cells
				// randomly.				
				if( i == 0 ){
					this.gm.seedCellAt( cellkind+1, this.C.midpoint )
				} else {
					this.gm.seedCell( cellkind+1 )
				}
			}
		}


	}
	
	runBurnin(){
		// Simulate the burnin phase
		let burnin = this.conf[&quot;BURNIN&quot;] || 0
		for( let i = 0; i &lt; burnin; i++ ){
			this.C.monteCarloStep()
		}
	}

	
	// draw the canvas
	drawCanvas(){
	
		// Add the canvas if required
		if( !this.helpClasses[&quot;canvas&quot;] ){ this.addCanvas() }
	
		// Clear canvas and draw stroma border
		this.Cim.clear( this.conf[&quot;CANVASCOLOR&quot;] )
		
		

		// Draw each cellkind appropriately
		let cellcolor=this.conf[&quot;CELLCOLOR&quot;], actcolor=this.conf[&quot;ACTCOLOR&quot;], 
			nrcells=this.conf[&quot;NRCELLS&quot;], cellkind, cellborders = this.conf[&quot;SHOWBORDERS&quot;]
		for( cellkind = 0; cellkind &lt; nrcells.length; cellkind ++ ){
		
			// draw the cells of each kind in the right color
			if( cellcolor[ cellkind ] != -1 ){
				this.Cim.drawCells( cellkind+1, cellcolor[cellkind] )
			}
			
			// Draw borders if required
			if(  cellborders[ cellkind  ]  ){
				let bordercol = &quot;000000&quot;
				if( this.conf.hasOwnProperty(&quot;BORDERCOL&quot;) ){
					bordercol = this.conf[&quot;BORDERCOL&quot;][cellkind]
				}
				this.Cim.drawOnCellBorders( cellkind+1, bordercol )
			}
			
			// if there is an activity constraint, draw activity values depending on color.
			if( this.C.conf[&quot;LAMBDA_ACT&quot;] !== undefined &amp;&amp; this.C.conf[&quot;LAMBDA_ACT&quot;][ cellkind + 1 ] &gt; 0 ){ //this.constraints.hasOwnProperty( &quot;ActivityConstraint&quot; ) ){
				if( actcolor[ cellkind ] ){
					this.Cim.drawActivityValues( cellkind + 1 )//, this.constraints[&quot;ActivityConstraint&quot;] )
				}			
			}

		}
		
	}
	
	// Computing and logging stats
	logStats(){
		
		// compute centroids for all cells
		let allcentroids = this.C.getStat( CentroidsWithTorusCorrection )
		
		for( let cid of this.C.cellIDs() ){
		
			let thecentroid = allcentroids[cid]
			
			// eslint-disable-next-line no-console
			console.log( this.time + &quot;\t&quot; + cid + &quot;\t&quot; + 
				this.C.cellKind(cid) + &quot;\t&quot; + thecentroid.join(&quot;\t&quot;) )
			
		}

	}
	
	// Listener for something that needs to be done after every monte carlo step.
	postMCSListener(){
	
	}
	
	// Function for creating outputs
	createOutputs(){
		// Draw the canvas every IMGFRAMERATE steps
		if( this.imgrate &gt; 0 &amp;&amp; this.time % this.imgrate == 0 ){
			
			if( this.mode == &quot;browser&quot; ){
				this.drawCanvas()
			}
			
			// Save the image if required and if we&apos;re in node (not possible in browser)
			if( this.mode == &quot;node&quot; &amp;&amp; this.saveimg ){
				this.drawCanvas()
				let outpath = this.conf[&quot;SAVEPATH&quot;], expname = this.conf[&quot;EXPNAME&quot;] || &quot;mysim&quot;
				this.Cim.writePNG( outpath +&quot;/&quot; + expname + &quot;-t&quot;+this.time+&quot;.png&quot; )
			}
		}
		
		// Log stats every LOGRATE steps
		if( this.logstats &amp;&amp; this.time % this.lograte == 0 ){
			this.logStats()
		}
	}
	
	// Run a montecarlostep and produce outputs if required.
	step(){
		if( this.running ){
			this.C.monteCarloStep()
			this.postMCSListener()
			this.createOutputs()
			this.time++
		}
	}
	
	// toggle running
	toggleRunning(){
		this.running = !this.running
	}
	
	// Run the entire simulation.
	run(){
		while( this.time &lt; this.conf[&quot;RUNTIME&quot;] ){
		
			this.step()
			
		}
	}
	
}


export default Simulation</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
