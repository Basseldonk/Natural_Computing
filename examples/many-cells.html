<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="../build/cpm.js"></script>
<style type="text/css">
canvas{ border: 1px solid black }
</style>

<script src="fpsmeter.min.js"></script>

<script>
"use strict"

let zoom=2, w = 40, t = 5000, ncells = 2


let C,meter
function timestep(){
	meter.tickStart()
	C.monteCarloStep()
	meter.tick()
	if( t-- > 0 ){
		requestAnimationFrame( timestep )
	}
}
function initialize(){
	C = setupCPM({zoom:zoom,w:w})
	timestep()
}

let pdc, Cs
function setupCPM(conf){
	const zoom = conf.zoom || 1
	const w = conf.w || 200
	let C = new CPM.CPM( [w,w], {
		T : 20,
		torus : true
	})
	Cs = new CPM.PostMCSStats()
	C.add( new CPM.Adhesion( { J: [[0,20], [20,100]] } ) )
	C.add( new CPM.VolumeConstraint( { V: [0,500], 
		LAMBDA_V: [0,50] } ) )
	pdc = new CPM.PreferredDirectionConstraint( 
		{LAMBDA_DIR: [0,1], PERSIST: [0,.9] } ) 
	C.add( pdc )
	C.add( Cs )
;
	let Cim = new CPM.Canvas( C, {zoom:zoom} )

	C.add( { postMCSListener : function(){
		// Clear the canvas (in the backgroundcolor white), and redraw:
		Cim.clear( "FFFFFF" )
		// The cell in red
		Cim.drawCells( 1, "00FF00" )
		// activity values on top of cell
		//Cim.drawActivityValues( 1, A )
		Cim.drawCellBorders( 1, "000000" )
		let ctx = Cim.context()
		ctx.beginPath()
		ctx.lineWidth = 2*zoom
		for( let i of Object.keys(pdc.celldirections) ){
			//console.log( pdc.cellcentroidlists[i][0])
			//console.log( pdc.cellcentroidlists[i][0]*zoom,
			//	pdc.cellcentroidlists[i][1]*zoom,
			//	zoom, zoom )
			//ctx.fillRect( pdc.cellcentroids[i][0]*zoom,
			//	pdc.cellcentroids[i][1]*zoom,
			//	zoom, zoom
		       	//)
			ctx.moveTo( pdc.cellcentroids[i][0]*zoom,
				pdc.cellcentroids[i][1]*zoom,
		       	)
			ctx.lineTo( (pdc.cellcentroids[i][0]+10*pdc.celldirections[i][0])*zoom,
				(pdc.cellcentroids[i][1]+10*pdc.celldirections[i][1])*zoom,
		       	)
		}
		ctx.stroke()
	}} )

	let Gi = new CPM.GridInitializer(C)
	for( let i = 0 ; i < ncells ; i ++ ){
		Gi.seedCell(1)
		//let cid = C.makeNewCellID(1)
		//C.setpix( C.grid.midpoint, cid )
	}

	// Start simulation
	meter = new FPSMeter({left:"auto", right:"5px"})
	return C
}

</script>
</head>
<body onload="initialize()">
<p>Many moving cells.</p>
</body>
</html>
