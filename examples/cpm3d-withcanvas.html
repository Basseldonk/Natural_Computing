<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>3D CPM</title>
	<meta charset="utf-8">
	<style type="text/css">
		body
		{
			background-color: white;
			margin: 5 ; padding: 5;
		}
	</style>


<script src="../build/cpm.js"></script>
<script src="fpsmeter.min.js"></script>
<script type="text/javascript">


let ncells = 1

/* Global variables that are not model parameters
	stopit tracks whether the simulation is running.
*/
let stopit = 0 // track whether the simulation is running (start/stop button)


let zoom=10, w = 100
let C,meter, Cim, pdc, renderer

function initialize(){
	C = setupCPM({zoom:zoom,w:w})
	Cim = new CPM.Canvas3D( C, {zoom:zoom} )
}
  		

function mainloop(){
	C.monteCarloStep()
	Cim.clear()
	Cim.drawCells( 1, "0000FF" )
	Cim.drawCells( 2, "000000")
	Cim.drawActivityValues( 2 )
	Cim.render()
	Cim.controls.update()
	meter.tick()
	if( !stopit ){
		requestAnimationFrame( mainloop )
	}
	
}

function setupCPM(conf){
  	const zoom = conf.zoom || 1
  	const w = conf.w || 40
	const dimension = 3
  	C = new CPM.CPM( [w,w,w], {
  		T : 20,
  		torus : [true,true,true],
  		J: [[0,20,20], [20,100,100], [20,100,100]],
  		V: [0,1800,1800],
  		LAMBDA_V: [0,25,25],
  		P: [0,8600,8600],
  		LAMBDA_P:[0,0.01,0.01],
  		LAMBDA_DIR: [0,300,0], 
  		PERSIST: [0,0.8,0],
  		MAX_ACT : [0,0,40],
  		LAMBDA_ACT : [0,0,40],
  		ACT_MEAN : "geometric"
  	})
  	C.add( new CPM.PersistenceConstraint( C.conf ) )

	let Gi = new CPM.GridManipulator(C)
  	for( let i = 0 ; i < ncells ; i ++ ){
  		Gi.seedCell(1)
  		Gi.seedCell(2)
  	}

  	// Start simulation
  	meter = new FPSMeter({left:"auto", right:"5px"})
  	return C
}

function startanim(){
	stopit=0
	requestAnimationFrame( mainloop )
}

function stopanim(){
	stopit=1
}

</script>
</head>
<body onload="initialize();startanim()">

<div style="width:600px; margin:auto">

<!--<div id="sliders">
</div>-->
<div id ="stage">
</div>
<p></p>

<div>
  <button onclick="startanim()">start </button>
  <button onclick="stopanim()">stop </button>
  <button onclick="reset()"> reset </button>
  <button onclick="requestAnimationFrame( mainloop )">step simulation</button>

</div>
</div>

</body>
</html>
